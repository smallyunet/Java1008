## Day06

### 子查询

#### 什么是子查询

	子查询是指插入在其他SQL语句中的SELECT语句，也称为嵌套查询。

#### 什么时候使用子查询

1. 当要显示的数据在表里并不存在，但可以通过对已有数据的加工获得，可通过子查询实现。
2. 子查询可以出现在SELECT、WHERE子句、FROM子句、DML语句、DDL语句中。
3. 在SELECT、INSERT、UPDATE或DELETE命令中允许是一个表达式的地方都可以包含子查询，子查询甚至可以包含在另外一个子查询中。

#### 子查询的编写思路

1. 仔细分析题目，确定要查询的表及字段（数据）
2. 分析要查询的字段（数据）哪些在表里直接存在，哪些不存在
3. 考虑如何把要显示的数据造出来（通过查询语句获得）
4. 考虑子查询与表的连接点是什么(通常是主外键、共有字段)
5. 考虑子查询放在什么位置
6. 组合成完整的SQL语句	

#### 按照子查询所在位置

一、在查询条件中使用子查询 
	
在执行子查询操作的语句中，子查询也称为内查询，包含子查询的查询语句也被称为外查询或主查询。

1. 单行子查询
    - 在WHERE子句中的单行子查询
    - 在HAVING子句中的单行子查询
    - 单行子查询中经常遇到的错误
        1. 因为WHERE条件限定不规范而返回多行，就会出现单行子查询返回多行的错误。
        2. WHERE子查询中不能包含ORDER BY 子句，相反任何排序都必须在外部查询中完成。
2. 多行子查询
    - 多行子查询中使用IN操作符
    - 多行子查询中使用ANY操作符
    - 多行子查询中使用ALL操作符
    - 子查询中使用EXISTS操作符
3. 多列子查询
4. 关联子查询

二、在建表语句中使用子查询

表的复制：

    CREATE TABLE  表名 	AS  SELECT  语句

只复制表结构：

    CREATE TABLE 表名 	AS   [SELECT 语句 FROM... WHERE 条件不成立]

三、在INSERT语句中使用子查询

    INSERT INTO 表名(字段列表) [SELECT 语句];

使用INSERET SELECT 语句可以将一个数据表中的数据插入到另一个新的数据表中。插入时要注意以下几点：

1. 必须保证插入的表已经存在。
2. 对于插入新数据的表，各个需要插入数据的列与类型必须与源数据表中各列数据类型保持一致
3. 必须明确是否存在默认值，是否允许为NULL值，如果不允许为空，则必须在插入的时候，为这些列提供列值。

注意：插入表的字段个数和类型与SELECT语句中的字段个数和类型要匹配

四、在UPDATE语句中使用子查询

    UPDATE 表名 SET 字段1 = (SELECT  语句）；

五、在DELETE语句中使用子查询

六、FROM子句中使用子查询（分页查询）

#### 使用子查询的注意事项	

1. 要将子查询放入圆括号中。
2. 子查询可出现在WHERE子句、FROM子句、SELECT 列表（此处只能是一个单行子查询）和HAVING子句,DDL,DML中。
3. 子查询不能出现在主查询的GROUP BY语句中
4. 子查询和主查询可以使用不同表，只要子查询返回的结果能够被主查询使用即可。
5. 单行子查询只能使用单行操作符，多行子查询只能使用多行操作符。
6. 在多行子查询中，ALL和ANY操作符不能单独使用，而只能与单行比较符（=、<、>、<=、>=、<>)结合使用。
7. 要注意子查询中的空值问题。如果子查询返回了一个空值，则主查询将不会查询任何结果。
8. 子查询允许嵌套多层，但不能超过255层。

### 集合操作

- UNION 并集（去除结果集的重复行），取查询结果的并集，会自动去掉重复行。
- UNION ALL并集（不去除结果集的重复行），取查询结果的并集，不去掉重复行。不进行排序排列
- INTERSECT  交集， 取两个结果集的交集，也就是在两个结果集中都存在的记录。最后结果以第一列的结果进行升序排列
- MINUS 差集，显示在A中存在，而在B中不存在的数据。结果以第一列的结果进行升序排列。

### 索引

#### 什么是索引

索引：类似“目录”，给一张表添加了一个目录

#### 索引的作用

1. 为了提高查询效率
2. 通过快速定位数据的方法，减少磁盘I/O操作

#### 创建索引的原则

创建索引的原则：

1. 适合创建索引的情况：
    - 字段有主键约束
    - 字段有唯一约束 
    - 字段取值分布范围很广
    - 字段中包含大量空值
    - 字段经常出现在 WHERE 子句或连接条件中

2. 不适合建索引的情况：
    - 表很小
    - 字段不经常出现在 WHERE 子句中
    - 字段经常更新

#### 如何创建索引

    CREATE INDEX 索引名称 ON 表名（字段1，字段2）;

索引信息与表独立存放：Oracle 数据库自动使用和维护索引，不需要特意使用，只需要创建就可以。

1. 自动: 当在表上定义一个PRIMARY KEY 或者UNIQUE 约束条件时,Oracle数据库自动创建一个对应的唯一索引.
2. 手动: 用户可以创建索引以加速查询.

#### 索引的删除

    DROP INDEX 索引名称;

